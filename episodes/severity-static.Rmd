---
title: 'Estimate severity'
teaching: 10
exercises: 2
editor_options: 
  chunk_output_type: inline
---

:::::::::::::::::::::::::::::::::::::: questions 

- How to estimate static CFR from linelist data?

- Why to adjust a CFR with a delay distribution?

- How to differentiate the CFR estimation from linelist vs incidence?

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: objectives

- Estimate static CFR
- Estimate a delay adjusted static CFR
- Use with `{epiparamater}` (for any refer to package vignette)
- Estimate severity heterogeneity
- Estimate rolling CFR

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: prereq

## Prerequisites

- `{epiparameter}`

:::::::::::::::::::::::::::::::::

## Introduction

What is the likely public health impact of the outbreak? Is this being or going to be a public health problem? These are common questions at the early stage of an epidemic.

The clinical severity is one of the key measurements to estimate the pandemic potential ([Fraser et al., 2009](https://www.science.org/doi/full/10.1126/science.1176062)) useful for planning scenarios ([CDC, 2016](https://www.cdc.gov/flu/pandemic-resources/national-strategy/severity-assessment-framework-508.html))

![HHS Pandemic Planning Scenarios based on the Pandemic Severity Assessment Framework. This uses a combined measure of clinical severity and transmissibility to characterize influenza pandemic scenarios. The horizontal axis is the scaled measure of clinical severity, ranging from 1 to 7, where 1 is low, 4 is moderate, and 7 is very severe. The vertical axis is the scaled measure of transmissibility, ranging from 1 to 5, where 1 is low, 3 is moderate, and 5 is highly transmissible. On the graph, HHS pandemic planning scenarios are labeled across four quadrants (A, B, C and D). From left to right, the scenarios are “seasonal range,” “moderate pandemic,” “severe pandemic” and “very severe pandemic.” As clinical severity increases along the horizontal axis, or as transmissibility increases along the vertical axis, the severity of the pandemic planning scenario also increases. HHS: United States Department of Health and Human Services.](fig/hhs-scenarios-psaf.png)

The case fatality ratio or CFR, defined as the ratio of deaths from an infectious disease to the number of cases, is a measure of severity. However, calculating this directly from the cumulative number of deaths to cases during the course of an epidemic tends to result in a biased CFR ([Nishiura et al., 2009](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0006852)).

In this tutorial we are going to learn how to use `{cfr}` to correct a CFR estimation using the appropriate delay distributions.

```{r,message=FALSE,warning=FALSE}
# Load package ----------------------------------------------
library(cfr)
library(tidyverse)
```

[Delay distribution]{#delaydist}
: Probability distribution of a key time period. 

## Naive CFR

cfr

naive cfr = nCFR

nCFR = deaths / cases

cases = recovered + death + unknown status

right-censoring refers to the unknown status

[1] one way to solve this was removing the unknown status (suggesting in Ghani)

[2] other method scale the number of cases in the denominator

ct = daily incidence *
ft = proportion of cases with delay between onset and death
ut = underestimation of known outcomes

ut is used to *scale* the value of the cumulative number of cases in the denominator, when calculating cfr

cfr = deaths / (cases * ut)

hfr
daily incidence * proportion of cases with delay between hospitalization and death

- time static

- right-censoring bias

figure <https://www.thelancet.com/journals/laninf/article/PIIS1473-3099(20)30243-7/fulltext#%20>

Disease severity is measured in terms of case fatality ratio ($cfr$) --total number of deaths $D$ divided by total number of cases $C$.

$$ cfr =  \frac{D}{C}. $$


```{r}
# Load the Ebola 1976 data provided with the package --------
data("ebola1976")

# view top data
ebola1976 %>% as_tibble()
```

The `cfr` package requires only a data frame with three columns,`date`, `cases`, and `deaths`, giving the daily number of reported cases and deaths. The below code chuck creates such data frame from the simulated Ebola dataset.

```{r}
# Calculate the static CFR without correcting for delays ----
cfr_static(data = ebola1976)
```

However, this is a naive, biased estimates value for the true $cfr$; because it does not account for the delay between case being reported and knowing its outcome. 

> During the outbreak of severe acute respiratory syndrome (SARS) in 2002–03, it was shown that this estimator, bt, considerably underestimates the cCFR [8]. This is easily demonstrated by relating Ct and Dt to the incidence function ct (i.e. the number of new confirmed cases on day t), and the conditional probability density function fs of the time from onset to death, given death. ([Nishiura et al. 2009](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0006852#s2))

```{r}
# show nishiura example, if possible
```


## Method: Adjusted CFR

- what do we need to estimate it?

```{r, message=FALSE, warning=FALSE}

# Load package ----------------------------------------------
library(epiparameter)

# Get delay distribution ------------------------------------
onset_to_death_ebola <- epiparameter::epidist_db(
  disease = "Ebola",
  epi_dist = "onset_to_death",
  single_epidist = TRUE)
```

## Method: Censoring or Delays?

The delay adjustment can be adjusted by censoring

```{r}
epiparameter::epidist_db(
  epi_dist = "onset_to_death",
  # disease = "COVID-19"
  ) %>% 
  list_distributions()

onset_to_death <- 
  epiparameter::epidist_db(
  disease = "Marburg",
  epi_dist = "onset_to_death",
  single_epidist = TRUE)

onset_to_death$method_assess
```


for early stage of epidemic, by delays instead of censoring

Ghani

[Ghani et al., 2005](https://academic.oup.com/aje/article/162/5/479/82647)


```{r}
# methods
```

- naive CFR vs adjusted CFR

### limitation

> Our unbiased estimation of the cCFR does not address all sources of error in data (e.g. underdiagnosis of infected individuals) and we summarize the relevant issues in the discussion. 

## Calculate adjusted CFR

Now, we use  `cfr_static()` to calculate overall disease severity.

```{r}
# Calculate the static CFR while correcting for delays ------
cfr_static(
  data = ebola1976,
  delay_density = function(x) density(onset_to_death_ebola, x)
)
```

This analysis indicated that the overall disease severity is, roughly, between $49\%$ and $51\%$. The function can also calculate unbiased $cfr$ if distribution of delays between cases being reported and knowing their outcome (death or recovery), which can be obtained from `epiparameter` package, is provided.

This analysis indicated that the overall disease severity is between $49\%$ and $53\%$, slightly higher than the static one.

### Use any distribution

For a distributions refresher

<https://github.com/epiverse-trace/tutorials/blob/md-outputs-PR-104/read-delays.md#functions-for-the-normal-distribution>

To use any distribution, refer to vignette

- distirbutional
- distcrete
- epiparameter

<https://epiverse-trace.github.io/cfr/articles/delay_distributions.html>

### Should we remove unknown outcomes from the linelist?

- linelist vs incidence estimation

Refer to: <https://github.com/epiverse-trace/cfr/issues/79>

[Lipsitch et al., 2005](https://journals.plos.org/plosntds/article/figure?id=10.1371/journal.pntd.0003846.t001)

```{r}
# show if possible
```

### why to use discrete distributions over continuous distributions

From <https://epiverse-trace.github.io/cfr/articles/delay_distributions.html>
> Note that discretised distributions are the more appropriate choice to be passed to cfr_*(), as we are usually working with daily case and death data. We do use continuous distributions in many examples as we do not expect this difference to bias the estimates excessively.

## Severity heterogeneity

From <https://royalsocietypublishing.org/doi/10.1098/rstb.2016.0371>

> The CFR may differ across populations (e.g. age, space, treatment); quantifying these heterogeneities can help target resources appropriately and compare different care regimens. 


### Assessment: estimate CFR by age group

```{r}
#find data
```

## Rolling CFR

- cumulative sum

```{r}
# last rolling equal to the static estimate
cfr_static(
  data = ebola1976,
  delay_density = function(x) dgamma(x, shape = 2.40, scale = 3.33)
)
```


Also,  severity of a disease can change over time. The `cfr` package provides functions to estimate biased and unbiased (by considering the delays), static, and time-varying $cfr$s. 

```{r}
# Calculate the rolling daily CFR while correcting for delays --------------------
rolling_cfr_corrected <- cfr_rolling(
  data = ebola1976,
  delay_density = function(x) density(onset_to_death_ebola, x)
)

tail(rolling_cfr_corrected)
```

```{r}
rolling_cfr_corrected$method <- "corrected"

# visualise both corrected and uncorrected rolling estimates
ggplot(rolling_cfr_corrected) +
  geom_ribbon(
    aes(
      date,
      ymin = severity_low, ymax = severity_high,
      fill = method
    ),
    alpha = 0.2, show.legend = FALSE
  ) +
  geom_line(
    aes(date, severity_mean, colour = method)
  )
```

### assessment: explain the bias

```{r}
# Calculate the CFR without correcting for delays on each day of the outbreak ----
rolling_cfr_naive <- cfr_rolling(
  data = ebola1976
)

tail(rolling_cfr_naive)

rolling_cfr_naive$method <- "naive"

# combine the data for plotting
data_cfr <- bind_rows(
  rolling_cfr_naive,
  rolling_cfr_corrected
)

# visualise both corrected and uncorrected rolling estimates
ggplot(data_cfr) +
  geom_ribbon(
    aes(
      date,
      ymin = severity_low, ymax = severity_high,
      fill = method
    ),
    alpha = 0.2, show.legend = FALSE
  ) +
  geom_line(
    aes(date, severity_mean, colour = method)
  )

```


### estimate HFR

- hospitalization fatality ratio

HFR in figure
<https://www.nature.com/articles/s41467-020-19238-2>

- look for parameters from epiparameter

```{r}
library(epiparameter)

epidist_db() %>% 
  list_distributions() %>% 
  count(epi_distribution)

epidist_db(epi_dist = "onset to death") %>% 
  list_distributions()

epidist_db(
  epi_dist = "hospitalisation to death") %>% 
  list_distributions()
```

::::::::::::::::::::::::::::::::::::: keypoints 

- Use `{cfr}` to estimate severity

::::::::::::::::::::::::::::::::::::::::::::::::

