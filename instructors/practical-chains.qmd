---
title: "Week 3: Estimate superspreading and simulate transmission chains"
format: 
  pdf: default # learners solutions
  docx: default # learners practical
  gfm: default # instructors
keep-md: true
format-links: false
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

::: {.content-hidden when-format="pdf"}

<!-- visible for instructors only -->
<!-- practical-week.md is generated from practical-week.qmd. Please edit that file -->
<!-- commit .md and .qmd files together -->

:::

Welcome!

A reminder of our Code of Conduct: 
<https://github.com/epiverse-trace/.github/blob/main/CODE_OF_CONDUCT.md>


# Practical

<!-- visible for learners and instructors at practical -->

Before your start, as a group:
- Create one copy of the Posit Cloud project `<paste link>`.
- Solve each challenge using the `Code chunk` as a guide.
- Paste your figure and table outputs.
- Write your answer to the questions.
- Choose one person from your group to share your results with everyone.


## Account for superspreading

Estimate extent of individual-level variation (i.e. the dispersion parameter) of the offspring distribution and the proportion of transmission that is linked to ‘superspreading events’ using the following available inputs:

- line list of cases
- contact tracing data

As a group, Write your answer to these questions:

- What set has more infections related to fewer clusters in the contact network?
- What set has the most skewed histogram of secondary cases?
- Does the estimated dispersion parameter correlate with the contact network and histogram of secondary cases?
- What is the proportion of new cases originating from a cluster of at least 10 cases?
- Would you recommend a backward tracing strategy?
- Interpret: How would you communicate these results to a decision-maker?
- Compare: What differences you identify from other group outputs? (if available)

### Inputs

| Group | Data | Parameters |
|---|---|---|
| 1 | <https://epiverse-trace.github.io/tutorials-middle/data/set-01-contacts.rds>, <https://epiverse-trace.github.io/tutorials-middle/data/set-01-linelist.rds> | R = 0.8, k = 0.01 |
| 2 | <https://epiverse-trace.github.io/tutorials-middle/data/set-02-contacts.rds>, <https://epiverse-trace.github.io/tutorials-middle/data/set-02-linelist.rds> | R = 0.8, k = 0.1 |
| 3 | <https://epiverse-trace.github.io/tutorials-middle/data/set-03-contacts.rds>, <https://epiverse-trace.github.io/tutorials-middle/data/set-03-linelist.rds> | R = 0.8, k = 0.5 |
| 4 | <https://epiverse-trace.github.io/tutorials-middle/data/set-04-contacts.rds>, <https://epiverse-trace.github.io/tutorials-middle/data/set-04-linelist.rds> | R = 1.5, k = 0.01 |
| 5 | <https://epiverse-trace.github.io/tutorials-middle/data/set-05-contacts.rds>, <https://epiverse-trace.github.io/tutorials-middle/data/set-05-linelist.rds> | R = 1.5, k = 0.1 |
| 6 | <https://epiverse-trace.github.io/tutorials-middle/data/set-06-contacts.rds>, <https://epiverse-trace.github.io/tutorials-middle/data/set-06-linelist.rds> | R = 1.5, k = 0.5 |


::: {.content-visible when-format="docx"}

### Code chunk

```r
# Load packages -----------------------------------------------------------
library(epiparameter)
library(EpiNow2)
library(tidyverse)


# Read reported cases -----------------------------------------------------

# faded code

```

### Your answers

Group 1

| output | paste here |
|---|---|
| contact network |  |
| histogram |  |
| parameter estimates |  |
| probability estimates |  |

Write your answer to the questions above:

```







```


------------------------

Group 2

| output | paste here |
|---|---|
| contact network |  |
| histogram |  |
| parameter estimates |  |
| probability estimates |  |


Write your answer to the questions above:

```







```


------------------------

Group 3

| output | paste here |
|---|---|
| contact network |  |
| histogram |  |
| parameter estimates |  |
| probability estimates |  |


Write your answer to the questions above:

```







```


------------------------

Group 4

| output | paste here |
|---|---|
| contact network |  |
| histogram |  |
| parameter estimates |  |
| probability estimates |  |


Write your answer to the questions above:

```







```


------------------------

Group 5

| output | paste here |
|---|---|
| contact network |  |
| histogram |  |
| parameter estimates |  |
| probability estimates |  |


Write your answer to the questions above:

```







```


------------------------

Group 6

| output | paste here |
|---|---|
| contact network |  |
| histogram |  |
| parameter estimates |  |
| probability estimates |  |


Write your answer to the questions above:

```







```
:::

::: {.content-visible unless-format="docx"}

### Solution

<!-- visible for instructors and learners after practical (solutions) -->

#### Code

##### Set 1 (sample)

```{r}
#| warning: false
#| eval: false

# Load packages -----------------------------------------------------------
library(epicontacts)
library(fitdistrplus)
library(tidyverse)


# Read linelist and contacts ----------------------------------------------
dat_contacts <- readr::read_rds(
  "https://epiverse-trace.github.io/tutorials-middle/data/set-01-contacts.rds"
)

dat_linelist <- readr::read_rds(
  "https://epiverse-trace.github.io/tutorials-middle/data/set-01-linelist.rds"
)


# Create an epicontacts object -------------------------------------------
epi_contacts <-
  epicontacts::make_epicontacts(
    linelist = dat_linelist,
    contacts = dat_contacts
  )

epi_contacts

# visualize the contact network
contact_network <- epicontacts::vis_epicontacts(epi_contacts)

contact_network


# Count the individual reproduction number for all observed cases --------

# count secondary cases per infector
infector_secondary <- epi_contacts %>%
  purrr::pluck("contacts") %>%
  dplyr::count(from, name = "secondary_cases")

# get number of secondary cases for each subject in {epicontacts} object
all_secondary <- epi_contacts %>%
  # extract ids from both contact and linelist using "which" argument
  epicontacts::get_id(which = "all") %>%
  # transform vector to dataframe to use left_join()
  tibble::enframe(name = NULL, value = "from") %>%
  # join count secondary cases per infectee
  dplyr::left_join(infector_secondary) %>%
  # infectee with missing secondary cases are replaced with zero
  tidyr::replace_na(
    replace = list(secondary_cases = 0)
  )

## plot the distribution of the number of secondary cases
individual_reproduction_num <- all_secondary %>%
  ggplot(aes(secondary_cases)) +
  geom_histogram(binwidth = 1) +
  labs(
    x = "Number of secondary cases",
    y = "Frequency"
  )

individual_reproduction_num


# Fit a negative binomial distribution -----------------------------------
offspring_fit <- all_secondary %>%
  dplyr::pull(secondary_cases) %>%
  fitdistrplus::fitdist(distr = "nbinom")

offspring_fit


# Estimate proportion of new cases from a cluster of secondary cases -----

# Set seed for random number generator
set.seed(33)

# Estimate the proportion of new cases originating from 
# a cluster of at least 5, 10, or 25 secondary cases from a primary case
# given known reproduction number and dispersion parameter.
proportion_cases_by_cluster_size <-
  superspreading::proportion_cluster_size(
    R = offspring_fit$estimate["mu"],
    k = offspring_fit$estimate["size"],
    cluster_size = c(5, 10, 25)
  )

proportion_cases_by_cluster_size
```


#### Outputs

##### Group 4: COVID 60 days

With reporting delay plus Incubation time:
![image](https://hackmd.io/_uploads/S1q6ItjvC.png){width=50%}

With reporting delay plus Incubation time:
```
> summary(covid60_epinow_delays)
                            measure               estimate
                             <char>                 <char>
1:           New infections per day     1987 (760 -- 4566)
2: Expected change in daily reports      Likely decreasing
3:       Effective reproduction no.     0.81 (0.43 -- 1.3)
4:                   Rate of growth -0.047 (-0.2 -- 0.092)
5:     Doubling/halving time (days)      -15 (7.5 -- -3.5)
```

#### Interpretation

Interpretation template:

+ From the summary of our analysis we see that the expected change in reports is 
`Likely decreasing` with the estimated new infections, on average, of
`1987` with 90% credible interval of `760` to `4566`.

+ ...

Interpretation Helpers:

- About the effective reproduction number:
    - An Rt greater than 1 implies an increase in cases or an epidemic. 
    - An Rt less than 1 implies a decrease in cases or extinction.
- ...

:::



## Simulate transmission chains

Estimate ... using the following available inputs:

- input 1
- input 2

As a group, Write your answer to these questions:

- ... phase?
- ... results expected?
- Interpret: How would you communicate these results to a decision-maker?
- Compare: What differences you identify from other group outputs? (if available)

### Inputs

| Group | Incidence | Link |
|---|---|---|
| 1 | COVID 30 days | <https://epiverse-trace.github.io/tutorials-middle/data/covid_30days.rds> |
| 2 | Ebola 35 days |  |
| 3 | Ebola 60 days |  |
| 4 | COVID 60 days |  |


| Disease | params |
|---|---|
| Ebola | ... |
| COVID | ... |

: {tbl-colwidths="[15,85]"}

::: {.content-visible when-format="docx"}

### Code chunk

```r
# Load packages -----------------------------------------------------------
library(epiparameter)
library(EpiNow2)
library(tidyverse)


# Read reported cases -----------------------------------------------------

# faded code

```

### Your answers

Group 1

| output | paste here |
|---|---|
| figure |  |
| table |  |

Write your answer to the questions above:

```







```


------------------------

Group 2

| output | paste here |
|---|---|
| figure |  |
| table |  |

Write your answer to the questions above:

```







```


------------------------

Group 3

| output | paste here |
|---|---|
| figure |  |
| table |  |

Write your answer to the questions above:

```







```


------------------------

Group 4

| output | paste here |
|---|---|
| figure |  |
| table |  |

Write your answer to the questions above:

```







```
:::

::: {.content-visible unless-format="docx"}

### Solution

<!-- visible for instructors and learners after practical (solutions) -->

#### Code

##### Set 1 (sample)

```{r}
#| warning: false
#| eval: false

# Load packages -----------------------------------------------------------
library(epiparameter)
library(epichains)
library(tidyverse)


# Set input parameters ---------------------------------------------------
known_basic_reproduction_number <- 0.8
known_dispersion <- 0.01
chain_to_explore <- 683


# Set iteration parameters -----------------------------------------------

# Number of simulation runs
number_chains <- 1000

# Number of initial cases
initial_cases <- 1

# Create generation time as <epiparameter> object
generation_time <- epiparameter::epiparameter(
  disease = "disease x",
  epi_name = "generation time",
  prob_distribution = "gamma",
  summary_stats = list(mean = 3, sd = 1)
)


# Simulate multiple chains -----------------------------------------------

# Set seed for random number generator
set.seed(33)

simulated_chains_map <-
  # iterate one function across multiple numbers (chain IDs)
  map(
    # vector of numbers (chain IDs)
    .x = seq_len(number_chains),
    # function to iterate to each chain ID number
    .f = function(sim) {
      simulate_chains(
        # simulation controls
        n_chains = initial_cases,
        statistic = "size",
        stat_threshold = 500,
        # offspring
        offspring_dist = rnbinom,
        mu = known_basic_reproduction_number,
        size = known_dispersion,
        # generation
        generation_time = function(x) generate(x = generation_time, times = x)
      ) %>%
        # creates a column with the chain ID number
        mutate(chain_id = sim)
    }
  ) %>%
  # combine list outputs (for each chain ID) into a single data frame
  list_rbind()

simulated_chains_map


# Explore suggested chain ------------------------------------------------
simulated_chains_map %>%
  # use data.frame output from <epichains> object
  as_tibble() %>% 
  filter(chain_id == chain_to_explore) %>% 
  print(n=Inf)


# visualize ---------------------------------------------------------------

# daily aggregate of cases
simulated_chains_day <- simulated_chains_map %>%
  # use data.frame output from <epichains> object
  as_tibble() %>%
  # transform chain ID column to factor (categorical variable)
  mutate(chain_id = as_factor(chain_id)) %>%
  # get the round number (day) of infection times
  mutate(day = ceiling(time)) %>%
  # count the daily number of cases in each simulation (chain ID)
  count(chain_id, day, name = "cases") %>%
  # calculate the cumulative number of cases for each simulation (chain ID)
  group_by(chain_id) %>%
  mutate(cases_cumsum = cumsum(cases)) %>%
  ungroup()

# Visualize transmission chains by cumulative cases
ggplot() +
  # create grouped chain trajectories
  geom_line(
    data = simulated_chains_day,
    mapping = aes(
      x = day,
      y = cases_cumsum,
      group = chain_id
    ),
    color = "black",
    alpha = 0.25,
    show.legend = FALSE
  ) +
  # define a 100-case threshold
  geom_hline(aes(yintercept = 100), lty = 2) +
  labs(
    x = "Day",
    y = "Cumulative cases"
  )
```


#### Outputs

##### Group 4: COVID 60 days

With reporting delay plus Incubation time:
![image](https://hackmd.io/_uploads/S1q6ItjvC.png){width=50%}

With reporting delay plus Incubation time:
```
> summary(covid60_epinow_delays)
                            measure               estimate
                             <char>                 <char>
1:           New infections per day     1987 (760 -- 4566)
2: Expected change in daily reports      Likely decreasing
3:       Effective reproduction no.     0.81 (0.43 -- 1.3)
4:                   Rate of growth -0.047 (-0.2 -- 0.092)
5:     Doubling/halving time (days)      -15 (7.5 -- -3.5)
```

#### Interpretation

Interpretation template:

+ From the summary of our analysis we see that the expected change in reports is 
`Likely decreasing` with the estimated new infections, on average, of
`1987` with 90% credible interval of `760` to `4566`.

+ ...

Interpretation Helpers:

- About the effective reproduction number:
    - An Rt greater than 1 implies an increase in cases or an epidemic. 
    - An Rt less than 1 implies a decrease in cases or extinction.
- ...

:::

# end